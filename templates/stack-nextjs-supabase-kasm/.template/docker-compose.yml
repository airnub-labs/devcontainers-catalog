services:
  devcontainer:
{{#templateOption.usePrebuiltImage}}
    image: ghcr.io/airnub-labs/devcontainer-images/dev-web:latest
{{/templateOption.usePrebuiltImage}}
{{^templateOption.usePrebuiltImage}}
    build:
      context: ./.devcontainer
      dockerfile: Dockerfile
{{/templateOption.usePrebuiltImage}}
    user: "vscode"
    volumes:
      - ..:/workspaces:cached
    command: sleep infinity
    depends_on:
      kasm-chrome:
        condition: service_healthy
  # --- Browser sidecar: Kasm Chrome (KasmVNC)
  kasm-chrome:
    image: kasmweb/chrome:1.17.0
    shm_size: "2gb"
    restart: unless-stopped
    ports:
      - "6901:6901"          # HTTPS + WebSocket UI
    environment:
      VNC_PW: "${KASM_VNC_PW:-student}"
    healthcheck:
      test: ["CMD-SHELL", "((wget --no-check-certificate -qO- https://localhost:6901/ >/dev/null 2>&1) || (curl -kfsS https://localhost:6901/ >/dev/null 2>&1) || (command -v nc >/dev/null 2>&1 && nc -z localhost 6901) || (echo >/dev/tcp/localhost/6901))"]
      interval: 15s
      timeout: 5s
      retries: 6
      start_period: 30s
