name: Commit Lint

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  commitlint:
    name: Validate Commit Messages
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install commitlint
        run: npm install --global @commitlint/cli @commitlint/config-conventional

      - name: Validate commit messages
        id: lint
        run: |
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.event.pull_request.head.sha }}

          git log --format=%H "${BASE_SHA}..${HEAD_SHA}" | while read commit; do
            echo "Linting commit: $commit"
            git log --format=%B -n 1 "$commit" | commitlint
          done
        continue-on-error: true

      - name: Comment on PR if invalid commits found
        if: steps.lint.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const lines = [
              '## ‚ùå Invalid Commit Messages',
              '',
              'This pull request contains commits that do not follow the Conventional Commits specification.',
              '',
              '### Valid Format',
              '',
              '```',
              '<type>[optional scope]: <description>',
              '',
              '[optional body]',
              '',
              '[optional footer(s)]',
              '```',
              '',
              '### Allowed Types',
              '',
              '- `feat`',
              '- `fix`',
              '- `docs`',
              '- `style`',
              '- `refactor`',
              '- `perf`',
              '- `test`',
              '- `build`',
              '- `ci`',
              '- `chore`',
              '- `revert`',
              '',
              'Please fix your commit messages and force push to update this pull request.'
            ];

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: lines.join('\n')
            });

      - name: Fail when commit lint errors detected
        if: steps.lint.outcome == 'failure'
        run: exit 1
