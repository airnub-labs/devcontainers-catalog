name: Security Scanning

on:
  pull_request:
    paths:
      - '**/package.json'
      - '**/package-lock.json'
      - 'images/**'
      - 'features/**/Dockerfile'
      - '.github/workflows/ci-security-scan.yml'
  push:
    branches:
      - main
  schedule:
    - cron: '0 9 * * 1'

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  trivy-npm-scan:
    name: Trivy - NPM Dependencies
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - path: tools/airnub-devc
            name: airnub-devc
          - path: packages/sdk-codespaces-adapter
            name: sdk-codespaces-adapter
          - path: tools/catalog-generator
            name: catalog-generator
          - path: packages/sidecar-agent
            name: sidecar-agent
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner (npm)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          scan-ref: ${{ matrix.path }}
          format: sarif
          output: trivy-${{ matrix.name }}-results.sarif
          severity: CRITICAL,HIGH,MEDIUM
          vuln-type: library
          ignore-unfixed: true
          exit-code: '0'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-${{ matrix.name }}-results.sarif
          category: trivy-npm-${{ matrix.name }}

      - name: Generate human-readable report
        if: github.event_name == 'pull_request'
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          scan-ref: ${{ matrix.path }}
          format: table
          output: trivy-${{ matrix.name }}-report.txt
          severity: CRITICAL,HIGH
          ignore-unfixed: true

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          PACKAGE_NAME: ${{ matrix.name }}
        with:
          script: |
            const fs = require('fs');
            const packageName = process.env.PACKAGE_NAME;
            const reportPath = `trivy-${packageName}-report.txt`;
            const report = fs.existsSync(reportPath) ? fs.readFileSync(reportPath, 'utf8').trim() : '';
            const content = report.length > 0 ? report : 'No CRITICAL or HIGH vulnerabilities detected.';

            const body = [
              `## üîí Trivy Security Scan: \`${packageName}\``,
              '',
              '```',
              content,
              '```',
              '',
              '<details>',
              '<summary>‚ÑπÔ∏è About this scan</summary>',
              '',
              'This scan checks for known vulnerabilities in npm dependencies.',
              '- **Severity**: CRITICAL, HIGH, MEDIUM',
              '- **Unfixed vulnerabilities**: Ignored',
              '- **Full report**: Available in the Security tab',
              '',
              '</details>'
            ].join('\n');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  trivy-docker-scan:
    name: Trivy - Docker Images
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - context: images/dev-base
            name: dev-base
          - context: images/dev-web
            name: dev-web
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Docker image for scanning
        working-directory: ${{ matrix.context }}
        run: docker build -t ${{ matrix.name }}:scan .

      - name: Run Trivy vulnerability scanner (Docker)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ matrix.name }}:scan
          format: sarif
          output: trivy-docker-${{ matrix.name }}-results.sarif
          severity: CRITICAL,HIGH
          vuln-type: os,library
          ignore-unfixed: true
          exit-code: '0'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-docker-${{ matrix.name }}-results.sarif
          category: trivy-docker-${{ matrix.name }}

      - name: Generate SBOM (CycloneDX)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ matrix.name }}:scan
          format: cyclonedx
          output: sbom-${{ matrix.name }}.json

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-docker-${{ matrix.name }}
          path: sbom-${{ matrix.name }}.json
          retention-days: 90

  trivy-config-scan:
    name: Trivy - Misconfigurations
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Trivy misconfiguration scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: config
          scan-ref: .
          format: sarif
          output: trivy-config-results.sarif
          severity: CRITICAL,HIGH
          exit-code: '0'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-config-results.sarif
          category: trivy-config
